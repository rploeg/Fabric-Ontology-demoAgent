# Fabric Ontology Demo Specification
# Version: 3.3 (Modular)
# Last Updated: January 2026

version: "3.3"
schema: fabric-ontology-demo-spec
name: fabric-ontology-demo-v2

description: |
  Expert agent specification for creating Microsoft Fabric Ontology demo scenarios.
  
  This modular version separates concerns:
  - Main spec: Constraints, defaults, references
  - agent-instructions.md: Phase-by-phase workflow
  - schemas/: Validation schemas for generated files
  - templates/: Reusable templates for deliverables

# =============================================================================
# MODULE REFERENCES
# =============================================================================
modules:
  agentInstructions: "./agent-instructions.md"
  schemas:
    bindings: "./schemas/bindings-schema.yaml"
    metadata: "./schemas/metadata-schema.yaml"
  templates:
    entity: "./templates/entity-template.yaml"
    relationship: "./templates/relationship-template.yaml"
    question: "./templates/question-template.md"
    htmlSlide: "./templates/html-slide-template.html"
    dataAgent: "./templates/data-agent-instructions.md"

# =============================================================================
# EXECUTION MODE
# =============================================================================
executionMode:
  strategy: incremental
  maxTokensPerResponse: 3000
  pauseBetweenPhases: true
  phases:
    - { id: discovery, name: "Phase 1: Discovery", output: confirm_requirements }
    - { id: design, name: "Phase 2: Design", output: ontology_structure_and_html, responses: 2 }
    - { id: ontology, name: "Phase 3: Ontology TTL", output: ttl_file_only }
    - { id: data, name: "Phase 4: Data Generation", output: one_csv_at_a_time }
    - { id: bindings, name: "Phase 5: Binding Instructions", output: yaml_and_markdown }
    - { id: queries, name: "Phase 6: Demo Questions", output: demo_questions_with_gql }
    - { id: readme, name: "Phase 7: Final Documentation", output: readme_and_metadata }

# =============================================================================
# CONSTRAINTS
# =============================================================================
constraints:
  # Property types allowed in Graph/Ontology
  propertyTypes:
    allowed: [string, int, double, boolean, datetime]
    notAllowed: [decimal, float, byte, array]
    warning: "⚠️ decimal returns NULL in Graph queries - use double instead"

  # Entity key constraints
  entityKeys:
    allowedTypes: [string, int]
    recommendation: "Use string for most keys for flexibility"
    warning: "⚠️ NEVER use datetime, boolean, or double as entity key"

  # Property naming rules
  propertyNames:
    maxLength: 26
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9_-]{0,24}[a-zA-Z0-9]$"
    uniqueAcrossOntology: true
    recommendation: "Use entity prefix: Product_Name, Batch_Status"

  # Data binding rules
  dataBinding:
    staticBeforeTimeseries: true
    staticSourceLimit: 1
    staticSourceType: OneLake
    timeseriesSourceTypes: [OneLake, Eventhouse]

  # Relationship rules
  relationships:
    sourceTargetMustBeDifferent: true
    sourceDataInOneLake: true
    # CRITICAL: Relationship binding column rules
    bindingRules: |
      ⚠️ CRITICAL: Relationship Binding Column Rules
      
      For relationship: Source Entity → Target Entity
      Using sourceTable: The table containing FKs to both entities
      
      - sourceKeyColumn: Column that identifies the SOURCE entity
        (This is typically a FK in sourceTable pointing to Source's PK)
      - targetKeyColumn: Column that identifies the TARGET entity
        (This is typically Target entity's PK or a FK to it)
      
      Example (Customer OWNS CreditCard):
        sourceTable: DimCreditCard (contains CustomerId FK and CardId PK)
        sourceKeyColumn: CustomerId  ✓ (FK to Customer, identifies source)
        targetKeyColumn: CardId      ✓ (PK of CreditCard, identifies target)

# =============================================================================
# GRAPH LIMITATIONS
# =============================================================================
graphLimitations:
  scale:
    maxGraphInstances: 10
    maxNodesAndEdges: 500_000_000
    maxHopsInQuery: 8
    queryTimeout: "20 minutes"
    maxResultSize: "64 MB"
  
  gqlNotSupported:
    - OPTIONAL MATCH
    - Undirected edges
    - Unbounded quantifiers (use {1,8})
    - ANY/ALL SHORTEST path
    - UNION DISTINCT
  
  gqlSupported:
    - MATCH with patterns
    - FILTER / WHERE
    - ORDER BY, OFFSET, LIMIT
    - GROUP BY with aggregates
    - Bounded quantifiers {1,N}
    - String functions (CONTAINS, STARTS WITH, ENDS WITH)

# =============================================================================
# KNOWN ISSUES (January 2026)
# =============================================================================
knownIssues:
  active:
    - id: materialized-view-binding
      description: "Cannot bind materialized views from Eventhouse"
      workaround: "Use regular KQL tables"
      
    - id: key-types
      description: "Entity keys must be string or int only"
      workaround: "Never use datetime, boolean, or double for keys"
      
    - id: boolean-rendering
      description: "Boolean values may not render in UI preview"
      workaround: "Values work in Graph queries"
      
    - id: managed-tables-only
      description: "Only managed Delta tables supported"
      workaround: "No external tables, shortcuts, or views"

  commonMistakes:
    - id: sourceKeyColumn-wrong
      description: "Misunderstanding sourceKeyColumn - it should be the FK pointing to source entity, not source's PK"
      error: "Relationship binding fails or returns no data"
      fix: |
        sourceKeyColumn should be the column in sourceTable that IDENTIFIES the source entity.
        For "Parent OWNS Child" using Child table: sourceKeyColumn = ParentId (FK)
        
    - id: column-not-in-table
      description: "sourceKeyColumn or targetKeyColumn doesn't exist in sourceTable"
      error: "Column not found error during binding"
      fix: "Verify both columns exist in the sourceTable you specified"

# =============================================================================
# DEFAULTS
# =============================================================================
defaults:
  entityCount: { min: 4, recommended: "6-8", max: 12 }
  multiHopDepth: { min: 2, recommended: "3-4", max: 8 }
  staticRows: { dimension: "15-30", fact: "30-50" }
  timeseriesRows: { perEntity: "30-50", span: "30 days" }

# =============================================================================
# DELIVERABLES
# =============================================================================
deliverables:
  ontology:
    - { path: "ontology/ontology-structure.md", description: "Entity/relationship summary with Mermaid ER diagram" }
    - { path: "ontology/ontology-diagram-slide.html", description: "Interactive presentation slide" }
    - { path: "ontology/{scenario}.ttl", description: "RDF/Turtle ontology (optional)" }
  
  data:
    - { path: "data/lakehouse/*.csv", description: "Dimension and fact tables" }
    - { path: "data/eventhouse/*.csv", description: "Timeseries tables" }
  
  bindings:
    - { path: "bindings/bindings.yaml", description: "Machine-readable binding config", required: true }
    - { path: "bindings/lakehouse-binding.md", description: "Human-readable static binding guide" }
    - { path: "bindings/eventhouse-binding.md", description: "Human-readable timeseries binding guide" }
  
  queries:
    - { path: "queries/demo-questions.md", description: "5 business questions with GQL" }
    - { path: "queries/data-agent-instructions.md", description: "Data Agent system prompt" }
  
  documentation:
    - { path: "README.md", description: "Demo overview and setup guide" }
    - { path: ".demo-metadata.yaml", description: "Automation tool metadata", required: true }

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
troubleshooting:
  binding:
    - symptom: "Cannot select Lakehouse"
      cause: "OneLake security enabled"
      fix: "Disable OneLake security in Lakehouse settings"
      
    - symptom: "Table not appearing"
      cause: "Not a managed Delta table"
      fix: "Use managed tables only"
      
    - symptom: "Properties show NULL"
      cause: "Using Decimal type"
      fix: "Change to Double type"
  
  gql:
    - symptom: "Syntax error on OPTIONAL MATCH"
      cause: "Not supported"
      fix: "Use separate MATCH statements"
      
    - symptom: "Error on unbounded *"
      cause: "Unbounded quantifiers not supported"
      fix: "Use bounded {1,8}"

# =============================================================================
# REFERENCES
# =============================================================================
references:
  documentation:
    - { title: "IQ Overview", url: "https://learn.microsoft.com/en-us/fabric/iq/overview" }
    - { title: "Data Binding", url: "https://learn.microsoft.com/en-us/fabric/iq/ontology/how-to-bind-data" }
    - { title: "Graph Limitations", url: "https://learn.microsoft.com/en-us/fabric/graph/limitations" }
    - { title: "GQL Guide", url: "https://learn.microsoft.com/en-us/fabric/graph/gql-language-guide" }
  
  knownIssues:
    - { title: "IQ Known Issues", url: "https://support.fabric.microsoft.com/known-issues/?product=IQ" }

# =============================================================================
# VERSION HISTORY
# =============================================================================
versionHistory:
  - version: "3.3"
    date: "2026-01-06"
    changes:
      - "Modular restructure - extracted agent instructions, schemas, templates"
      - "Clarified sourceKeyColumn constraint"
      - "Added commonMistakes section"
      
  - version: "3.2"
    date: "2026-01-05"
    changes:
      - "Added bindings/bindings.yaml as required deliverable"
      
  - version: "3.1"
    date: "2026-01-05"
    changes:
      - "Added automation integration and .demo-metadata.yaml"
