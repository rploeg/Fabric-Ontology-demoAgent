# Validation Rules Contract
# These rules MUST be implemented consistently across all SDK versions

version: "2.0.0"
description: |
  Validation rules that must be enforced by all SDK implementations.
  Non-compliance with these rules should raise ValidationError.
  
  Updated to align with official Fabric Ontology API specification and OpenAPI contract.

rules:
  # ==========================================================================
  # Reserved Words
  # ==========================================================================
  
  reservedWords:
    description: "Names that are not allowed (GQL, GraphQL, and Fabric-specific)"
    source: "https://learn.microsoft.com/en-us/fabric/graph/gql-reference-reserved-terms"
    words:
      # GQL keywords
      - match
      - return
      - filter
      - where
      - let
      - order
      - limit
      - offset
      - distinct
      - group
      - by
      - asc
      - desc
      - and
      - or
      - not
      - "true"
      - "false"
      - "null"
      - is
      - in
      - starts
      - ends
      - contains
      - with
      - as
      - node
      - edge
      - path
      - trail
      - union
      - all
      # GQL functions
      - count
      - sum
      - avg
      - min
      - max
      - coalesce
      - size
      - labels
      - nodes
      - edges
      - upper
      - lower
      - trim
      - char_length
      # GraphQL keywords
      - query
      - mutation
      - subscription
      - fragment
      - on
      - type
      - interface
      - enum
      - scalar
      - input
      - directive
      - extend
      - schema
      - implements
      # Fabric-specific
      - ontology
      - entity
      - relationship
      - property
      - binding
      # Common type names that may conflict
      - id
      - string
      - int
      - float
      - boolean
      - datetime
      # GraphQL pagination/query terms
      - first
      - last
      - after
      - before
      - skip
      - take
      - orderBy
    caseSensitive: false
    errorMessage: "Name '{name}' is a reserved word and cannot be used"
    applies_to:
      - Property.name
      - EntityType.name
      - RelationshipType.name

  problematicWords:
    description: "Words that trigger warnings (not errors) - singular forms that may conflict"
    level: warning
    words:
      - product
      - store
      - sale
      - event
      - item
      - order
      - customer
      - user
      - account
      - transaction
      - record
      - entry
      - asset
    caseSensitive: false
    warningMessage: "Name '{name}' is a common singular word that may conflict with plural forms. Consider using a more specific name."
    applies_to:
      - EntityType.name

  # ==========================================================================
  # Name Pattern Validation
  # ==========================================================================

  namePattern:
    description: "Pattern for valid names - must start and end with alphanumeric, 1-26 characters"
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9_-]{0,24}[a-zA-Z0-9]$"
    errorMessage: "Name must be 1-26 characters, start and end with alphanumeric, contain only alphanumeric characters, underscores, or hyphens"
    source: "https://learn.microsoft.com/en-us/fabric/iq/ontology/how-to-create-entity-types"
    applies_to:
      - Property.name
      - EntityType.name
      - RelationshipType.name

  # ==========================================================================
  # Length Constraints
  # ==========================================================================

  nameLength:
    description: "Maximum length for name fields"
    maxLength: 26
    applies_to:
      - Property.name
      - EntityType.name
      - RelationshipType.name
    errorMessage: "Name '{name}' exceeds maximum length of 26 characters"
    source: "https://learn.microsoft.com/en-us/fabric/iq/ontology/how-to-create-entity-types"

  displayNameLength:
    description: "Maximum length for displayName fields"
    maxLength: 256
    applies_to:
      - Property.displayName
      - EntityType.displayName
      - RelationshipType.displayName
    errorMessage: "Display name exceeds maximum length of 256 characters"

  descriptionLength:
    description: "Maximum length for description fields"
    maxLength: 4000
    applies_to:
      - Property.description
      - EntityType.description
      - RelationshipType.description
    errorMessage: "Description exceeds maximum length of 4000 characters"

  # ==========================================================================
  # Data Type Validation
  # ==========================================================================

  validDataTypes:
    description: "Allowed data types for properties (Fabric-supported only)"
    values:
      - String
      - BigInt      # UI shows "Integer", API uses "BigInt"
      - Double
      - Boolean
      - DateTime
      - Object
      - Float
    unsupportedTypes:
      - Decimal     # CRITICAL: Returns NULL in Graph queries - use Double instead
    caseSensitive: true
    errorMessage: "Invalid data type '{dataType}'. Must be one of: {validTypes}"
    decimalErrorMessage: "Decimal type is not supported by Fabric Graph - use Double instead. Decimal properties will return NULL in Graph queries."
    applies_to: [Property.dataType]
    notes:
      - "The Fabric UI shows 'Integer' but the API uses 'BigInt' internally"
      - "Decimal is NOT supported - use Double instead"

  keyDataTypes:
    description: "Data types allowed for key (primary key) properties"
    values:
      - String
      - BigInt
    errorMessage: "Key property '{name}' must be String or BigInt (Integer), got {dataType}. Only string and integer properties can be used as keys."
    applies_to: [Property.dataType where Property.isKey == true]
    notes:
      - "From official docs: 'Only string and integer properties can be used as keys'"

  validSemanticTypes:
    description: "Allowed semantic types for properties (internally defined)"
    values:
      - Id
      - Name
      - Status
      - Timestamp
      - Location
      - Quantity
      - Price
      - Description
      - Category
      - Tag
    caseSensitive: true
    allowNull: true
    errorMessage: "Invalid semantic type '{semanticType}'"
    applies_to: [Property.semanticType]
    notes:
      - "Semantic types are internally defined, not from an external standard"

  validCardinality:
    description: "Allowed cardinality values for relationships"
    values:
      - One
      - Many
    caseSensitive: true
    errorMessage: "Invalid cardinality '{cardinality}'. Must be 'One' or 'Many'"
    applies_to:
      - RelationshipType.fromCardinality
      - RelationshipType.toCardinality

  validBindingTypes:
    description: "Allowed binding types"
    values:
      - NonTimeSeries   # Lakehouse binding
      - TimeSeries      # Eventhouse binding
    applies_to: [DataBinding.dataBindingType]

  validDataSourceTypes:
    description: "Allowed data source types"
    values:
      - LakehouseTable
      - KustoTable
    applies_to: [DataBinding.sourceType]

  # ==========================================================================
  # Required Field Validation
  # ==========================================================================

  requiredFields:
    Property:
      - id
      - name
      - dataType
    EntityType:
      - id
      - name
      - namespace        # Always "usertypes" for custom types
      - namespaceType    # Always "Custom" for user-defined types
    RelationshipType:
      - id
      - name
      - sourceEntityTypeId   # Internal field name
      - targetEntityTypeId   # Internal field name
    LakehouseBinding:
      - workspaceId
      - lakehouseId      # itemId in API format
      - tableName
    EventhouseBinding:
      - workspaceId
      - eventhouseId     # itemId in API format
      - databaseName
      - tableName
      - clusterUri
      - timestampColumn  # Required for time-series bindings
    RelationshipContextualization:
      - id
      - workspaceId
      - itemId
      - tableName

  # ==========================================================================
  # Cross-Field Validation
  # ==========================================================================

  primaryKeyValidation:
    description: "Entity types should have at least one primary key property"
    level: warning
    message: "EntityType '{name}' has no primary key defined"
    applies_to: [EntityType]

  keyPropertyReferenceValidation:
    description: "Key property IDs must reference existing properties"
    level: error
    message: "EntityType '{name}' key references unknown property ID: {propertyId}"
    applies_to: [EntityType.keyPropertyIds]

  relationshipEntityValidation:
    description: "Relationship must reference existing entity types"
    level: error
    message: "Relationship '{name}' references non-existent entity"
    applies_to: [RelationshipType]

  sourceTargetDistinct:
    description: "Source and target entity types must be distinct"
    level: error
    message: "Relationship '{name}': source and target entity types must be distinct (both are ID: {entityTypeId})"
    applies_to: [RelationshipType]
    notes:
      - "From docs: 'The source and target entity types must be distinct from one another'"

  keyRefValidation:
    description: "Relationship contextualization key references must match entity entityIdParts"
    level: error
    sourceMessage: "sourceKeyRefBindings targetPropertyId '{propertyId}' must be present in the source EntityType's entityIdParts"
    targetMessage: "targetKeyRefBindings targetPropertyId '{propertyId}' must be present in the target EntityType's entityIdParts"
    applies_to: [RelationshipContextualization]
    notes:
      - "From docs: 'The source column selections must match the entity type keys'"

  columnMappingValidation:
    description: "Column mappings must reference existing properties"
    level: error
    message: "Column mapping references non-existent property ID {propertyId}"
    applies_to: [LakehouseBinding, EventhouseBinding]

  # ==========================================================================
  # Binding Validation Rules
  # ==========================================================================

  singleStaticBinding:
    description: "Each entity type supports at most one static (non-time-series) binding"
    level: error
    message: "Entity type '{name}' has {count} static bindings, but only one static binding is allowed per entity type"
    applies_to: [EntityType.dataBindings]
    notes:
      - "From docs: 'Each entity type supports one static data binding'"

  bindingOrder:
    description: "Static bindings must exist before time series bindings"
    level: error
    message: "Entity type '{name}' has time series bindings but no static binding. A static data binding must be created before any time series data bindings."
    applies_to: [EntityType.dataBindings]
    notes:
      - "From docs: 'Static data bindings must be created before time series data bindings'"

  # ==========================================================================
  # Uniqueness Validation
  # ==========================================================================

  entityTypeUniqueness:
    description: "Entity type names must be unique (case-insensitive)"
    level: error
    message: "Duplicate entity type names found: {names}"
    applies_to: [OntologyDefinition.entityTypes]

  relationshipTypeUniqueness:
    description: "Relationship type names must be unique (case-insensitive)"
    level: error
    message: "Duplicate relationship type names found: {names}"
    applies_to: [OntologyDefinition.relationshipTypes]

  propertyUniqueness:
    description: "Property names must be unique within an entity type (case-insensitive)"
    level: error
    message: "Duplicate property names found in entity type '{entityType}': {names}"
    applies_to: [EntityType.properties]

  globalPropertyUniqueness:
    description: "Property names must be unique across all entity types"
    level: error
    message: "Property '{name}' in '{entityType1}' also exists in '{entityType2}'. Property names must be unique across all entity types."
    applies_to: [OntologyDefinition.entityTypes]
    source: "https://learn.microsoft.com/en-us/fabric/iq/ontology/how-to-bind-data"
    notes:
      - "From official docs: 'Property names must be unique across all entity types'"

  # ==========================================================================
  # Format Validation
  # ==========================================================================

  uuidFormat:
    description: "Fields that must be valid UUIDs"
    pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
    applies_to:
      - DataBinding.workspaceId
      - LakehouseBinding.lakehouseId
      - EventhouseBinding.eventhouseId
      - DataBinding.id
      - RelationshipContextualization.id
      - RelationshipContextualization.workspaceId
      - RelationshipContextualization.itemId
    errorMessage: "Invalid UUID format for '{field}'"

  uriFormat:
    description: "Fields that must be valid URIs"
    applies_to:
      - EventhouseBinding.clusterUri
      - EntityDocument.uri
    errorMessage: "Invalid URI format for '{field}'"

  clusterUriFormat:
    description: "Eventhouse cluster URI format"
    pattern: "^https://[a-zA-Z0-9-]+\\.[a-zA-Z0-9-]+\\.kusto\\.windows\\.net/?$"
    example: "https://{cluster-name}.{region}.kusto.windows.net"
    applies_to: [EventhouseBinding.clusterUri]

  # ==========================================================================
  # ID Generation
  # ==========================================================================

  idGeneration:
    description: "Rules for auto-generating IDs when not provided"
    Property:
      method: "hash-based"
      algorithm: "Generate unique int64 from name + parent entity name"
      note: "Should be deterministic for same inputs"
    EntityType:
      method: "hash-based"
      algorithm: "Generate unique int64 from name"
    RelationshipType:
      method: "hash-based"
      algorithm: "Generate unique int64 from name + from/to entity names"

  # ==========================================================================
  # Fixed Values
  # ==========================================================================

  fixedValues:
    description: "Fields with fixed/default values for custom types"
    EntityType:
      namespace: "usertypes"
      namespaceType: "Custom"
      visibility: "Visible"  # Default, can also be "Hidden"
    RelationshipType:
      namespace: "usertypes"
      namespaceType: "Custom"
    LakehouseBinding:
      sourceSchema: "dbo"  # Default value
      sourceType: "LakehouseTable"
      dataBindingType: "NonTimeSeries"
    EventhouseBinding:
      sourceType: "KustoTable"
      dataBindingType: "TimeSeries"

  # ==========================================================================
  # GraphQL API Runtime Limits (Informational)
  # ==========================================================================

  graphQLLimits:
    description: "Runtime limits for GraphQL API queries (informational, not schema validation)"
    level: info
    limits:
      defaultPageSize:
        value: 100
        description: "Default number of items returned per page"
      maxPageSize:
        value: 100000
        description: "Maximum pagination size"
      maxReplySize:
        value: "64 MB"
        description: "Maximum response size"
      requestTimeout:
        value: "100 seconds"
        description: "Maximum request processing time"
      maxQueryDepth:
        value: 10
        description: "Maximum nesting depth for queries"
    source: "https://learn.microsoft.com/en-us/fabric/data-engineering/api-graphql-limits"
    notes:
      - "These are runtime limits, not schema validations"
      - "Exceeding these limits results in API errors, not validation errors"

  # ==========================================================================
  # KQL/Eventhouse Constraints (Informational)
  # ==========================================================================

  kqlConstraints:
    description: "KQL/Eventhouse-specific constraints (informational)"
    level: info
    identifierLength:
      min: 1
      max: 1024
      description: "KQL identifier length limits"
    caseSensitivity:
      databaseName: false
      tableName: true
      columnName: true
    reservedPrefixes:
      - "__"  # Double underscore prefix/suffix is reserved
    source: "https://learn.microsoft.com/en-us/kusto/query/schema-entities/entity-names"
