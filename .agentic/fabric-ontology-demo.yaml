version: 2.0
schema: fabric-ontology-demo-spec
name: fabric-ontology-demo
description: Expert agent for creating Microsoft Fabric Ontology demo scenarios

# CRITICAL: Generate deliverables incrementally to avoid length limits
executionMode:
  strategy: incremental
  maxTokensPerResponse: 3000
  steps:
    - phase: discovery
      output: confirm_requirements
    - phase: design
      output: ontology_structure_md_only
    - phase: ontology
      output: ttl_file_only
    - phase: data
      output: one_csv_at_a_time
    - phase: bindings
      output: binding_instructions
    - phase: queries
      output: demo_questions
    - phase: readme
      output: final_readme

constraints:
  propertyTypes: [string, int, double, boolean, datetime]
  keyTypesAllowed: [string, int]  # CRITICAL: No other types for entity keys
  decimalDisallowed: true  # Use double instead - decimal returns null in Graph
  staticBeforeTimeseries: true
  timestampRequiredForTimeseries: true
  managedTablesOnly: true
  oneLakeSecurityDisabled: true

defaults:
  entityCount: 4
  multiHopDepth: 2
  staticRowsPerTable: 30
  timeseriesRowsPerEntity: 30

# Compact deliverables spec - agent generates paths dynamically
deliverables:
  - { id: ttl, path: "ontology/{scenario}.ttl" }
  - { id: mermaid, path: "ontology/ontology.mmd" }
  - { id: structure, path: "ontology/ontology-structure.md" }
  - { id: html_slide, path: "ontology/ontology-diagram-slide.html" }
  - { id: dictionary, path: "data/data-dictionary.md" }
  - { id: lakehouse_csvs, path: "data/lakehouse/*.csv" }
  - { id: eventhouse_csvs, path: "data/eventhouse/*.csv" }
  - { id: lakehouse_binding, path: "bindings/lakehouse-binding.md" }
  - { id: eventhouse_binding, path: "bindings/eventhouse-binding.md" }
  - { id: queries, path: "queries/demo-questions.md" }
  - { id: readme, path: "README.md" }

# Templates only - no example data
templates:
  entity: |
    name: {EntityName}
    key: { name: {KeyName}, type: string }
    properties: [{ name: {PropName}, type: {type}, static|timeseries: true }]
    staticBinding: { table: {Table}, keyColumn: {Key}, propertyMap: {...} }
  
  relationship: |
    name: {relName}, source: {Entity1}, target: {Entity2}
    sourceTable: {Table}, mapping: { sourceKeyColumn: {FK1}, targetKeyColumn: {FK2} }
  
  question: |
    nlQuestion: {question}
    gqlQuery: MATCH (e:Entity) WHERE ... RETURN ...
    traversal: [Entity1 → relationship → Entity2]
    ontologyValue: {why ontology is better than traditional query}

  # Binding documentation template for entities with timeseries
  bindingWithTimeseries: |
    After the static property mappings table, if entity has timeseries properties, add:
    > ⚠️ **Note:** Timeseries properties ({comma-separated list}) are bound separately via Eventhouse.
    
    Example for Facility with DailyOutput, EquipmentUptime timeseries:
    > ⚠️ **Note:** Timeseries properties (DailyOutput, EquipmentUptime) are bound separately via Eventhouse.

  # HTML slide template structure
  htmlSlide: |
    Create interactive HTML slide with:
    - <!DOCTYPE html> with proper meta tags
    - Mermaid CDN: https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js
    - Gradient background (purple/blue theme)
    - White card container with rounded corners and shadow
    - Header: Title + subtitle
    - Info grid: 4 metric cards (entity count, relationships, multi-hop depth, target audience)
    - Diagram container with embedded Mermaid ER diagram
    - Legend: Color-coded items for entities, relationships, timeseries
    - Footer: Company name, domain, Microsoft Fabric Ontology, date
    - Responsive CSS and print-ready styles
    - Mermaid initialization script

# Condensed known issues - key points only
knownIssues:
  - "Keys must be string/int only"
  - "Use Double not Decimal (Decimal returns null)"
  - "Static binding required before timeseries"
  - "Timeseries needs timestamp column"
  - "Disable OneLake security for binding sources"
  - "Managed tables only (no external/materialized views)"
  - "Manual Graph refresh after data updates"
  - "XMLA endpoints needed for semantic model generation"

references:
  - https://learn.microsoft.com/en-us/fabric/iq/ontology/overview
  - https://learn.microsoft.com/en-us/fabric/iq/ontology/tutorial-1-create-ontology
  - https://learn.microsoft.com/en-us/fabric/iq/ontology/how-to-bind-data
  - https://github.com/falloutxAY/rdf-fabric-ontology-converter

# Agent instructions - MUST follow incremental approach
agentInstructions: |
  CRITICAL: To avoid hitting response length limits, follow this incremental workflow:
  
  ## Phase 1: Discovery (1 response)
  - Ask clarifying questions about domain, entities, relationships
  - Confirm requirements before proceeding
  - Output: Brief confirmation of scope
  
  ## Phase 2: Design (2 responses)  
  - Response 1: Output ontology-structure.md with entity/relationship summary and Mermaid diagram
  - Response 2: Generate ontology-diagram-slide.html - an interactive HTML slide with:
    * Professional styling with gradient background
    * Key metrics cards (entity count, relationship count, multi-hop depth, target users)
    * Embedded Mermaid ER diagram (copy from ontology-structure.md)
    * Color-coded legend
    * Footer with company/domain info
  - Do NOT generate CSVs or TTL yet
  
  ## Phase 3: Ontology TTL (1 response)
  - Output ONLY the .ttl file
  - Keep comments minimal
  
  ## Phase 4: Data Generation (multiple responses)
  - Generate ONE CSV file per response
  - Start with dimension tables, then fact tables
  - Finally generate timeseries table(s)
  
  ## Phase 5: Bindings (1 response)
  - Output binding instructions (lakehouse + eventhouse)
  - IMPORTANT: For EVERY entity that has timeseries properties, add a note callout after 
    the static property mappings table:
    > ⚠️ **Note:** Timeseries properties ({list properties}) are bound separately via Eventhouse.
  - This applies to ALL entities with timeseries, not just one
  
  ## Phase 6: Queries (1 response)
  - Output 5 demo questions with GQL
  
  ## Phase 7: README (1 response)
  - Final summary README
  
  RULES:
  - Never output more than ONE major deliverable per response
  - Keep CSV data to ~30-50 rows max
  - Use concise property names
  - Minimize inline comments
  - Ask user "Ready for next phase?" between phases
